#!/bin/bash

# Simple script to create a circos plot between two FASTA files.

############
### Help ###
############
Help()
{
cat << EOF

Simple script to create a circos plot between two FASTA files.
Copyright, Felipe Almeida <almeidafmarques@outlook.com>, 2021

 Syntax: plot_circos.sh [-h] [--fofn <fasta> --outdir <outdir> --minlen <int> --minid <int>
                              --linklen <int> --show_intrachr --gc_window <int> --gc_step <int>]

 Options:

 # Help
 -h/--help                           Print this help

 # Output
 --outdir                            Path to output directory [Default: ./results]

 # Input file of file names
 # CSV: fasta path,prefix,color
 --fofn                              File of file names contatining list of fastas to
                                     draw circos plot.

 # Input min. length
 --minlen                            Min size of contigs to consider for plot [Default: 10000]

 # Links (blastn) min. percentage id
 --minid                             Min. percentage id to filter the results of blastn to draw links [Default: 85]
 --linklen                           Min. link (blastn hit) length to display in plot [Default: 5000]
 --show_intrachr                     Tells the program to create a conf file showing intra chr links [Default: false]

 # GC skew config
 --gc_window                         GC skew window size [Default: 5000]
 --gc_step                           GC skew step size [Default: 5000]


EOF
}

################
### Defaults ###
################
RESULTS="./results" # tmp directory
FOFN=""
FASTA=""
FASTA_PREFIX=""
FASTA_COLOR=""
MINLEN=10000
MINID=85
MINLINKLEN=5000
INTRACHR_FILE="links_concatenated_colored_no_intrachr.txt"
INTRACHR_SHOW="no"
GCWINDOW=5000
GCSTEP=5000

######################################
### Function to filter FASTA files ###
######################################
filter()
{
# create results dir
mkdir -p $RESULTS

# create dir for files
mkdir -p ${RESULTS}/filtered

# filter genomes
IFS=','
while read -r FASTA FASTA_PREFIX FASTA_COLOR ; do
  name="$(basename $FASTA)" ;
  $CONDA_PREFIX/bin/perl $CONDA_PREFIX/bin/removesmalls.pl $MINLEN $FASTA >> ${RESULTS}/filtered/"$name" ;
  continue
done<"$FOFN"

}

##########################################
### Function to create karyotype files ###
##########################################
karyotype()
{
# create dir
mkdir -p ${RESULTS}/conf

# write karyotypes
IFS=','
while read -r FASTA FASTA_PREFIX FASTA_COLOR ; do
  name="$(basename $FASTA)" ;
  FILTERED_FASTA=${RESULTS}/filtered/"$name" ;
  bioawk -c fastx -v p=$FASTA_PREFIX -v color=$FASTA_COLOR \
    '{ printf "chr - " substr($name,1) " " p":" substr($name,1) " " "0" " " length($seq) " " color"\n" }' \
    $FILTERED_FASTA >> ${RESULTS}/conf/circos.sequences.txt ;
done<"$FOFN"
}

#############################################
### Function to find links between fastas ###
#############################################
find_links()
{
# create dir
mkdir -p ${RESULTS}/all_vs_all_blast

# concatenate genomes
cat ${RESULTS}/filtered/* >> ${RESULTS}/all_vs_all_blast/concatenated_genomes.fasta ;
export CONCAT_FASTA=${RESULTS}/all_vs_all_blast/concatenated_genomes.fasta
export BLAST_DB=${RESULTS}/all_vs_all_blast/blast_db

# Run blast
makeblastdb -in $CONCAT_FASTA -dbtype nucl -out $BLAST_DB &> /dev/null ;
blastn -task blastn -perc_identity $MINID -query $CONCAT_FASTA -db $BLAST_DB \
    -outfmt "6 qseqid qstart qend sseqid sstart send pident length mismatch gapopen evalue bitscore stitle" \
    -out ${RESULTS}/all_vs_all_blast/tmp.blast

# Filter blast
awk -F '\t' -v minid=$MINID '{ if ($7 >= minid) { print } }' ${RESULTS}/all_vs_all_blast/tmp.blast > ${RESULTS}/all_vs_all_blast/all_vs_all.blast

# Remove tmp
rm ${RESULTS}/all_vs_all_blast/tmp.blast
}

#########################################################################
### Function to parse blastn (links) and create conf file with colors ###
#########################################################################
parse_links()
{
# create dir
mkdir -p ${RESULTS}/conf

# Filter blocks with more then N bp hits
awk -v minlen=$MINLINKLEN '{ if ($8 >= minlen) { print } }' \
  ${RESULTS}/all_vs_all_blast/all_vs_all.blast | cut -f 1,2,3,4,5,6 >> ${RESULTS}/conf/links_concatenated.txt ;

# get links comming from contigs and give it colors
IFS=','
while read -r FASTA FASTA_PREFIX FASTA_COLOR ; do
  bioawk -c fastx '{ printf $name"\n" }' $FASTA > tmp_names.fasta ;
  awk -v color1=$FASTA_COLOR -F'\t' 'NR==FNR{c[$1]++;next};c[$1] > 0 {print $0 "\t" "color="color1}' \
    tmp_names.fasta ${RESULTS}/conf/links_concatenated.txt >> ${RESULTS}/conf/links_concatenated_colored.txt
  rm tmp_names.fasta ;
done<"$FOFN"

# create additional file whithout intrachr links
awk -F'\t' '{ if ($1 != $4) { print } }' ${RESULTS}/conf/links_concatenated_colored.txt > ${RESULTS}/conf/links_concatenated_colored_no_intrachr.txt ;
}

#############################################################################
### Function to sort and remove duplicates from links and karyotype files ###
#############################################################################
dedup()
{
for file in $(ls ${RESULTS}/conf/*); do
    sort -u $file > tmp.txt ;
    cat tmp.txt > $file ;
    rm tmp.txt
done
}

###############################################
### Function to check which chrs have links ###
###############################################
check_links()
{
# get chrs with links
## chr source
CHRS_1=$(cut -f 1 ${RESULTS}/conf/links_concatenated_colored_no_intrachr.txt | sort -u | tr '\n' ';')
## chr target
CHRS_2=$(cut -f 4 ${RESULTS}/conf/links_concatenated_colored_no_intrachr.txt | sort -u | tr '\n' ';')

# export LINE
export CUSTOM_CHR_LINE="chromosomes = "${CHRS_1}${CHRS_2}
}

#########################################################
### Function to create GC skew file proper for Circos ###
#########################################################
gc_skew()
{
# exec GCcalc.py
$CONDA_PREFIX/bin/python3 $CONDA_PREFIX/bin/GCcalc.py -f ${RESULTS}/all_vs_all_blast/concatenated_genomes.fasta -w $GCWINDOW -s $GCSTEP | \
    cut -f 1,2,3,5 | awk '{ if ($4 > 0) print $0 "\t" "color=dblue"; else print $0 "\t" "color=red"}' > ${RESULTS}/conf/GC_skew.txt
}

###########################################
### Function to create circos.conf file ###
###########################################
write_circos()
{
cat << EOF
# MINIMUM CIRCOS CONFIGURATION

# Defines unit length for ideogram and tick spacing, referenced
# using "u" prefix, e.g. 10u
chromosomes_units = 500000

# Show all chromosomes in karyotype file. By default, this is
# true. If you want to explicitly specify which chromosomes
# to draw, set this to 'no' and use the 'chromosomes' parameter.
chromosomes_display_default = no
${CUSTOM_CHR_LINE}

# Chromosome name, size and color definition
karyotype = circos.sequences.txt

<<include etc/colors_fonts_patterns.conf>>
<colors>
</colors>

<image>
<<include etc/image.conf>>
# overwrite auto_alpha_steps from default value included in etc/image.conf
auto_alpha_steps* = 10
</image>

<ideogram>

<spacing>
# spacing between ideograms
default = 0.005r
</spacing>

# ideogram position, thickness and fill
radius           = 0.9r
thickness        = 30p
fill             = yes
show_label	     = no
label_font	     = default
label_size	     = 40
label_radius	 = 1r + 75p
label_parallel	 = yes

</ideogram>

<links>
	<link>
		show     = yes
		ribbon   = no
		file     = ${INTRACHR_FILE}
		radius   = 0.8r
		tickness = 15

	<rules>

	<rule>
	 # Do not show intra-chromossome links
   condition  = var(intrachr)
   show       = ${INTRACHR_SHOW}
  </rule>

	</rules>

	</link>
</links>

# Add plots
<plots>

<plot>
type        = histogram
file        = GC_skew.txt
r1          = 1.0r
r0          = 0.8r
thickness   = 2
max         = 0.49999999999999173
min         = -0.47826086956521324
extend_bin  = yes
orientation = out
</plot>

</plots>

# debugging, I/O an dother system parameters
<<include etc/housekeeping.conf>> # included from Circos distribution

show_ticks = yes
show_tick_labels = yes

<ticks>

skip_first_label = no
skip_last_label  = no
radius           = dims(ideogram,radius_outer)
tick_separation  = 2p
label_separation = 5p
multiplier       = 1e-6
color            = black
thickness        = 4p
size             = 20p

# with you desired more ticks, add new tick inclusions as the one shown. See: http://circos.ca/documentation/tutorials/ticks_and_labels/labels/configuration
<tick>
spacing        = 1u
show_label     = yes
label_size     = 30p
label_offset   = 10p
format         = %d
grid           = yes
grid_color     = black
grid_thickness = 1p
grid_start     = 0.5r
grid_end       = 0.999r
</tick>

<tick>
skip_first_label = yes
spacing        = 0.5u
show_label     = yes
label_size     = 30p
label_offset   = 10p
format         = %.2fMb
grid           = yes
grid_color     = black
grid_thickness = 1p
grid_start     = 0.5r
grid_end       = 0.999r
</tick>

</ticks>

EOF
}

###############################
### Function to plot circos ###
###############################
plot_circos()
{
# get current dir
CURRENT_DIR=$PWD

# got to conf dir
cd ${RESULTS}/conf/

# draw
circos

# go back
cd $CURRENT_DIR
}


################################
### Get positional arguments ###
################################

# No arguments given
if [ $# -eq 0 ] ; then
    Help
    exit
fi

# arguments given
POSITIONAL=()
while [[ $# -gt 0 ]]
do
ARGS="$1"
case $ARGS in
    -h|--help)
      Help
      exit
      ;;
    --outdir)
      RESULTS=$2
      shift 2
      ;;
    --fofn)
      if [ "$2" ]; then
          if [[ -s "$2" && -z "$(tail -c 1 "$2")" ]]
          then
              echo "" > /dev/null ;
          else
              echo "" >> $2 ;
          fi
          FOFN=$2
          shift 2
      else
          echo -e '\nERROR: "--fofn" requires an argument\n'
          exit
      fi
      ;;
    --minlen)
      if [ "$2" ]; then
          MINLEN=$2
          shift 2
      else
          echo -e '\nERROR: "--minlen" requires a numeric argument\n'
          exit
      fi
      ;;
    --minid)
      if [ "$2" ]; then
          MINID=$2
          shift 2
      else
          echo -e '\nERROR: "--minid" requires a numeric argument\n'
          exit
      fi
      ;;
    --linklen)
      if [ "$2" ]; then
          MINLINKLEN=$2
          shift 2
      else
          echo -e '\nERROR: "--linklen" requires a numeric argument\n'
          exit
      fi
      ;;
    --gc_window)
      if [ "$2" ]; then
          GCWINDOW=$2
          shift 2
      else
          echo -e '\nERROR: "--gc_window" requires a numeric argument\n'
          exit
      fi
      ;;
    --gc_step)
      if [ "$2" ]; then
          GCSTEP=$2
          shift 2
      else
          echo -e '\nERROR: "--gc_step" requires a numeric argument\n'
          exit
      fi
      ;;
    --show_intrachr)
        INTRACHR_FILE="links_concatenated_colored.txt"
        INTRACHR_SHOW="yes"
        shift
      ;;
    *)
      printf "******************************\n"
      printf "Error: Invalid argument $1\n"
      printf "******************************\n"
      exit 1
esac
done

###################
### Exec script ###
###################

## remove existing results
rm -rf $RESULTS ;

# Step 1
echo " # Preparing inputs!"
filter          ;

# Step 2
echo " # Writing karyotypes!"
karyotype       ;

# Step 3
echo " # Finding links (all vs all blastn)!"
find_links      ;
parse_links     ;

# Step 4
echo " # Removing duplicate lines in conf files!"
dedup           ;
check_links     ;

# Step 5
echo " # Computing GC Skew!"
gc_skew         ;

# Step 6
echo " # Wrinting circos conf file!"
write_circos > ${RESULTS}/conf/circos.conf ;

# Step 7
echo " # Plotting circos!"
plot_circos     ;

cat << EOF

 # Bye Bye
 Now your plot is complete and must be available at: ${RESULTS}/conf/

 All the required files for a minimal circos plot have been produced and stored at ${RESULTS}/conf/.
 Now you can play with the ${RESULTS}/conf/circos.conf file in order to change the plot as you like.

 Remember to read the circos manual in order to understand the conf file.

 Have fun!

EOF
